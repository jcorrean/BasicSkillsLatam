---
title: "METODO (VE)"
author: "Juan C. Correa"
date: "2024-06-07"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Paso 1 (Creación de Corpus)
El primer paso, naturalmente, es definir la muestra de programas de postgrado en el país. Para ello, se utiliza la librería readtext de la siguiente manera

```{r}
library(readtext)
textos <- readtext("Venezuela/DATA_VE/")
textos$doc_id <- gsub(".pdf", "", textos$doc_id)
```

Luego, vamos a relacionar cada programa con su nivel educativo así:

```{r}
library(dplyr)
textos <- mutate(textos, 
                 Program = ifelse(
                   grepl("Doctorado en", text), "Doctor",
                        ifelse(grepl("Maestría", text), "Master", 
                               "Specialization")))
table(textos$Program)
```

Ahora, pasamos a crear el corpus lingüístico.

```{r}
library(quanteda)
Textos <- corpus(textos$text)
docvars(Textos, "Program") <- textos$Program
head(summary(Textos), 10)
```

```{r}
Programs <- tokens(Textos, 
                     remove_numbers = TRUE, 
                     remove_punct = TRUE, 
                     remove_url = TRUE, 
                     remove_symbols = TRUE) %>%  
  tokens_remove(stopwords("spanish"))
```

Ahora, pasamos a hacer a buscar con el filtro contextual así:

```{r}
s1 <- data.frame(kwic(Programs, pattern = phrase("pensamiento crítico")))
s2 <- data.frame(kwic(Programs, pattern = phrase("solucionar problemas")))
s3 <- data.frame(kwic(Programs, pattern = "comunicar"))
s4 <- data.frame(kwic(Programs, pattern = "creatividad"))
s5 <- data.frame(kwic(Programs, pattern = "paciencia"))
s6 <- data.frame(kwic(Programs, pattern = "crear"))
s7 <- data.frame(kwic(Programs, pattern = "liderar"))
s8 <- data.frame(kwic(Programs, pattern = "resolver"))
s9 <- data.frame(kwic(Programs, pattern = "comprometer"))
s10 <- data.frame(kwic(Programs, pattern = "comprometerse"))
s11 <- data.frame(kwic(Programs, pattern = "gestionar"))
s12 <- data.frame(kwic(Programs, pattern = "reflexionar"))
s13 <- data.frame(kwic(Programs, pattern = "controlar"))
s14 <- data.frame(kwic(Programs, pattern = "ético"))
s15 <- data.frame(kwic(Programs, pattern = "tolerar"))
s16 <- data.frame(kwic(Programs, pattern = "argumentar"))
s17 <- data.frame(kwic(Programs, pattern = "conflictos"))
s18 <- data.frame(kwic(Programs, pattern = "negociar"))
s19 <- data.frame(kwic(Programs, pattern = "comprender"))
s20 <- data.frame(kwic(Programs, pattern = "equipos"))
s21 <- data.frame(kwic(Programs, pattern = "planificar"))
s22 <- data.frame(kwic(Programs, pattern = "generar"))
s23 <- data.frame(kwic(Programs, pattern = "empatía"))
s24 <- data.frame(kwic(Programs, pattern = "compartir"))
s25 <- data.frame(kwic(Programs, pattern = "analizar"))
s26 <- data.frame(kwic(Programs, pattern = "reconocer"))
s27 <- data.frame(kwic(Programs, pattern = "orientar"))
s28 <- data.frame(kwic(Programs, pattern = "respetar"))
s29 <- data.frame(kwic(Programs, pattern = "motivar"))
s30 <- data.frame(kwic(Programs, pattern = "cooperar"))
s31 <- data.frame(kwic(Programs, pattern = "fortalecer"))
s32 <- data.frame(kwic(Programs, pattern = "impulsar"))
s33 <- data.frame(kwic(Programs, pattern = "acercar"))
s34 <- data.frame(kwic(Programs, pattern = "ayudar"))
s35 <- data.frame(kwic(Programs, pattern = "cambiar"))
s36 <- data.frame(kwic(Programs, pattern = "apreciar"))
s37 <- data.frame(kwic(Programs, pattern = "dirigir"))
s38 <- data.frame(kwic(Programs, pattern = "fomentar"))
s39 <- data.frame(kwic(Programs, pattern = "interactuar"))
s40 <- data.frame(kwic(Programs, pattern = "identificar"))
s41 <- data.frame(kwic(Programs, pattern = "competir"))
s42 <- data.frame(kwic(Programs, pattern = "manifestar"))
s43 <- data.frame(kwic(Programs, pattern = "responsable"))
s44 <- data.frame(kwic(Programs, pattern = "evaluar"))
s45 <- data.frame(kwic(Programs, pattern = "innovar"))
s46 <- data.frame(kwic(Programs, pattern = "decidir"))
s47 <- data.frame(kwic(Programs, pattern = phrase("tomar decisiones")))
s48 <- data.frame(kwic(Programs, pattern = "flexibilidad"))
s49 <- data.frame(kwic(Programs, pattern = "persua*"))
s50 <- data.frame(kwic(Programs, pattern = "convencer"))

df_list <- mget(paste0("s", 1:50))
SS <- do.call(rbind, df_list)
SS$Skill <- rownames(SS)
SS$Skill <- gsub("\\..*", "", SS$Skill)
rm(list=setdiff(ls(), "SS"))
variable.names(SS)
head(SS, 5)
```

# Paso 2: (Modelado de Red de Habilidades)

Ahora, pasamos a modelar las relaciones entre las habilidades y los programas de postgrado. Para ello, vamos a usar los datos de la tabla SS resultante del último código del paso anterior para construir la redd a través de una lista de aristas.

```{r}
network <- SS[c(1,8)]
head(network, 3)
```

Ahora, pasamos a graficar la red bipartita entre habilidades y programas

```{r}
library(igraph)
bn2 <- graph.data.frame(network,directed=FALSE)
bipartite.mapping(bn2)
V(bn2)$type <- bipartite_mapping(bn2)$type
V(bn2)$shape <- ifelse(V(bn2)$type, "circle", "square")
V(bn2)$label.cex <- ifelse(V(bn2)$type, 0.5, 1)
V(bn2)$size <- sqrt(igraph::degree(bn2))
E(bn2)$color <- "lightgrey"

bn2.pr <- bipartite.projection(bn2)
Terms <- bn2.pr$proj2

centrality_scores <- igraph::eigen_centrality(Terms)
centrality_scores <- centrality_scores$vector

color_palette <- colorRampPalette(c("#CE1127", "white", "#0A3A7E"))(length(unique(centrality_scores)))

# Assign colors to nodes based on their normalized centrality scores
node_colors <- color_palette[rank(centrality_scores)]

# Plot the network with node colors based on centrality
set.seed(56)
png("F1.png", width = 15, height = 7, units = 'in', res = 300)

plot(Terms, vertex.label.color = "black", vertex.label.cex = 0.8, vertex.color = node_colors, vertex.size = 15, edge.width = 0.5, edge.color = "lightgray", layout = layout_randomly, main = "")

dev.off()
```

Seguimos con el cálculo de la importancia de cada habilidad y analicemos la correlación entre los cuatro indicadores de centralidad para ver si se comportan de una manera semejante a lo esperado por la evidencia empírica sobre indicadores de centralidad. 

```{r}
BNA <- graph.data.frame(network, directed = FALSE)
Programs <- data.frame(Degree = igraph::degree(BNA),
                   Closeness = igraph::closeness(BNA),
                   Betweennes = igraph::betweenness(BNA),
                   Eigen = igraph::eigen_centrality(BNA))
Programs <- Programs[ -c(5:25) ]
rownames(Programs)
Programs$SS <- rownames(Programs)
Programs <- Programs[order(Programs$SS), ]
Programs <- Programs[grepl("s", Programs$SS), ]
Programs <- Programs[1:4]
colnames(Programs)[4] <- "Eigenvector"

library(psych)
png("F2.png", width = 12, height = 10, units = 'in', res = 300)
pairs.panels(Programs, 
             method = "spearman", 
             hist.col = "#0A3A7E",
             density = TRUE,  
             ellipses = TRUE,
             pch = 15,
             cex = 1,
             cex.axis = 1.8,
             cex.labels = 1.5,
             lwd = 2,
             rug = TRUE,
             stars = TRUE)
dev.off()

```

